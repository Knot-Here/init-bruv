---
- name: Check chezmoi binary
  become: false
  stat:
    path: "{{ chezmoi_bin }}"
  register: chez_stat

- name: Fail if chezmoi is missing (run bootstrap first)
  when: not chez_stat.stat.exists
  fail:
    msg: "chezmoi not installed for {{ user_home }}. Run: ansible-playbook -K playbooks/bootstrap.yml"

- name: Initialize chezmoi from your repo (first run only)
  become: false
  args:
    chdir: "{{ user_home }}"
    creates: "{{ user_home }}/.local/share/chezmoi/.git"
  shell: >
    "{{ chezmoi_bin }}"
    init --branch "{{ dotfiles_branch | default('main') }}"
    --apply "{{ dotfiles_repo }}"

- name: Apply chezmoi (keep in sync on subsequent runs)
  become: false
  shell: '"{{ chezmoi_bin }}" apply -v'
